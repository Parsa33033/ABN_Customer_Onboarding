@startuml
title Onboard flow: /onboarding -> CustomerService -> CustomerInteractionRepositoryImpl

actor Client
participant "CustomerApplication\n(onboard)" as App
participant "FileStorage" as FS
participant "CustomerServiceImpl\n(onboard)" as CS
participant "CustomerInteractionRepositoryImpl" as RepoImpl
participant "CustomerRepository (JPA)" as Jpa

Client -> App : POST /onboarding (data, photo, idDocument)
activate App

App -> App : mapRequestAndGenerateInternalIdentifier()
note right: creates CustomerApplicationData\nwith externalIdentifier

alt photo present
  App -> FS : persist(photo, externalIdentifier, FileType.PHOTO)
  activate FS
  FS --> App : photoPath (CompletableFuture)
  deactivate FS
end

alt id document present
  App -> FS : persist(idDocument, externalIdentifier, FileType.ID)
  activate FS
  FS --> App : idDocumentPath (CompletableFuture)
  deactivate FS
end

App -> CS : customerService.onboard(customerData)
activate CS

CS -> CS : validate(customerData)
CS -> RepoImpl : readByExternalIdentifier(externalIdentifier)
activate RepoImpl

RepoImpl -> Jpa : findByExternalIdentifier(externalIdentifier)
activate Jpa
Jpa --> RepoImpl : Optional<Customer> (found / empty)
deactivate Jpa

RepoImpl --> CS : Optional<CustomerData> (CompletableFuture)
deactivate RepoImpl

alt customer found
  CS -> CS : set readCustomerResult
else customer not found
  CS -> RepoImpl : write(customerDto)
  activate RepoImpl
  RepoImpl -> Jpa : save(Customer entity)
  activate Jpa
  Jpa --> RepoImpl : saved Customer
  deactivate Jpa
  RepoImpl --> CS : saved CustomerData (CompletableFuture)
  deactivate RepoImpl
end

CS -> CS : toCustomerData() -> CustomerData
CS --> App : CustomerData (CompletableFuture)
deactivate CS

App -> App : CustomerResponse.from(CustomerData)
App --> Client : 200 OK CustomerResponse
deactivate App
@enduml